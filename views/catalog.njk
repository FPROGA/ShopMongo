{% extends "layout.njk" %}

{% block content %}
<h1>üõí –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</h1>

<div class="products-grid">
  {% for product in products %}
    <div class="product-card">
      <h3>{{ product.name }}</h3>
      <p>{{ product.description }}</p>
      <div class="price">{{ product.price }} ‚ÇΩ</div>
      
      {% if user %}
        <form action="/api/orders" method="POST" class="buy-form">
          <!-- ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–´–ô JSON —Å –∫–∞–≤—ã—á–∫–∞–º–∏ -->
          <input type="hidden" name="items" 
                 value='[{"product_id": "{{ product._id.toString() }}", "quantity": 1}]'>
          <button type="submit" class="btn buy-btn">üõí –ö—É–ø–∏—Ç—å</button>
        </form>
      {% else %}
        <a href="/login" class="btn disabled">–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –¥–ª—è –ø–æ–∫—É–ø–∫–∏</a>
      {% endif %}
    </div>
  {% endfor %}
</div>

<script>
// –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ fetch –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å —Ñ–æ—Ä–º–∞–º–∏
document.addEventListener('DOMContentLoaded', function() {
  const forms = document.querySelectorAll('.buy-form');
  
  forms.forEach(form => {
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const itemsInput = this.querySelector('input[name="items"]');
      let items;
      
      try {
        items = JSON.parse(itemsInput.value);
      } catch (error) {
        alert('–û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞');
        return;
      }
      
      try {
        const response = await fetch('/api/orders', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({ items })
        });
        
        if (response.ok) {
          const result = await response.json();
          alert(`–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω! –ù–æ–º–µ—Ä: ${result.order_id}`);
          window.location.href = '/profile';
        } else {
          const errorText = await response.text();
          alert(`–û—à–∏–±–∫–∞: ${errorText}`);
        }
      } catch (error) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
      }
    });
  });
});
</script>

{% endblock %}